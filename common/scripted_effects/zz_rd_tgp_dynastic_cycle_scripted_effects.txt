##################################################
# Dynastic Cycle Scripted Effects
##################################################

# Effect called when claiming the Mandate of Heaven
tgp_claim_mandate_of_heaven_effect = {
	save_temporary_scope_as = new_emperor_temp
	if = {
		limit = {
			is_valid_celestial_dynasty = no
			situation:dynastic_cycle ?= {
				NOT = {
					situation_current_phase = situation_dynastic_cycle_phase_chaos
				}
			}
		}
		custom_tooltip = claim_mandate_trigger_conquest_tt
	}
	every_vassal = {
		limit = {
			any_held_title = {
				OR = {
					exists = var:ceremonial_title
					exists = var:administrative_ui_special_title
				}
			}
		}
		random_held_title = {
			limit = { exists = var:ceremonial_title }
			save_scope_as = ceremonial_title
		}
		save_temporary_scope_as = ceremonial_liege
		# TGP end the ceremonial liege
		# MESSAGE
		hidden_effect = {
			every_player = {
				limit = { top_liege = scope:ceremonial_liege.top_liege }
				send_interface_message = {
					type = event_generic_bad
					title = tgp_destroy_ceremonial_liege_throne_title
					left_icon = scope:ceremonial_liege
					right_icon = scope:new_emperor_temp
					show_as_tooltip = {
						scope:new_emperor_temp = { destroy_title = scope:ceremonial_title }
						scope:ceremonial_liege = { add_trait = former_emperor }
					}
				}
			}
		}
		# Actually destroy
		scope:ceremonial_liege = { add_trait = former_emperor }
		scope:new_emperor_temp = { destroy_title = scope:ceremonial_title }
	}
	set_variable = {
		name = claimed_mandate_var
		value = yes
		days = 30
	}
	# Grant the Hegemon title
	create_title_and_vassal_change = {
		type = created
		save_scope_as = mandate_change
		add_claim_on_loss = no
	}
	title:h_china = {
		change_title_holder = {
			holder = scope:new_emperor_temp
			change = scope:mandate_change
		}
	}
	resolve_title_and_vassal_change = scope:mandate_change
	# Adjust tributaries
	if = {
		limit = {
			number_of_tributaries > 0
		}
		# Vassalize tributaries within China (except if it's a player)
		create_title_and_vassal_change = {
			type = swear_fealty
			save_scope_as = mandate_vassalize_tributaries_change
		}
		every_tributary = {
			limit = {
				is_ai = yes
				primary_title = {
					target_is_de_jure_liege_or_above = title:h_china
				}
			}
			hidden_effect = { end_tributary = yes }
			change_liege = {
				liege = scope:new_emperor_temp
				change = scope:mandate_vassalize_tributaries_change
			}
		}
		resolve_title_and_vassal_change = scope:mandate_vassalize_tributaries_change
		# Turn your other tributaries into hegemonic
		every_tributary = {
			custom = custom.every_tributary
			limit = {
				NAND = {
					is_ai = yes
					primary_title = {
						target_is_de_jure_liege_or_above = title:h_china
					}
				}
			}
			start_tributary = {
				contract_group = tributary_celestial
				suzerain = scope:new_emperor_temp
			}
		}
	}
	scope:new_emperor_temp = {
		# Get some gold back from any owned domicile
		nomad_domicile_refund_effect = yes
		# Become celestial
		trigger_event = rd_asia.1180
		# Get the de jure capital if possible
		if = {
			limit = {
				title:h_china.title_capital_county.holder ?= {
					OR = {
						any_liege_or_above = { this = scope:new_emperor_temp }
						this = scope:new_emperor_temp
					}
				}
			}
			if = {
				limit = {
					title:h_china.title_capital_county.holder = {
						this != scope:new_emperor_temp
					}
				}
				create_title_and_vassal_change = {
					type = revoked
					save_scope_as = mandate_capital_change
					add_claim_on_loss = no
				}
				title:h_china.title_capital_county = {
					change_title_holder = {
						holder = scope:new_emperor_temp
						change = scope:mandate_capital_change
					}
				}
				resolve_title_and_vassal_change = scope:mandate_capital_change
			}
			set_realm_capital = title:h_china.title_capital_county
		}
		# Provide the new emperor with suitable rewards
		hidden_effect = {
			add_treasury = {
				value = gold
				min = 1000
			}
			change_influence = {
				value = monumental_influence_gain
				multiply = 4
			}
			add_legitimacy = mandate_legitimacy_max
		}
		dynasty = {
			add_dynasty_prestige = excessive_dynasty_prestige_value
		}
		add_character_modifier = claim_mandate_decision_modifier
		# Increase control of every owned county within China
		hidden_effect = {
			every_realm_county = {
				custom = custom_every_realm_county
				limit = {
					target_is_de_jure_liege_or_above = title:h_china
				}
				change_county_control = 25
			}
		}
		show_as_tooltip = { # We show this as a tooltip because it looks better than the above effect
			title:h_china = { change_county_control = 25 }
		}
		# Populate the emperor's court with high merit characters
		hidden_effect = {
			while = {
				count = 5
				
				create_character = {
					template = tgp_minister_administrator_template
					employer = scope:new_emperor_temp
					faith = scope:new_emperor_temp.faith
					culture = scope:new_emperor_temp.culture
					save_scope_as = mandate_new_administrator_temp
				}
				scope:mandate_new_administrator_temp ?= {
					change_merit = empire_starting_merit_value
					assign_completed_exams_based_on_merit_effect = yes
				}
				create_character = {
					template = tgp_minister_diplomat_template
					employer = scope:new_emperor_temp
					faith = scope:new_emperor_temp.faith
					culture = scope:new_emperor_temp.culture
					save_scope_as = mandate_new_diplomat_temp
				}
				scope:mandate_new_diplomat_temp ?= {
					change_merit = empire_starting_merit_value
					assign_completed_exams_based_on_merit_effect = yes
				}
				create_character = {
					template = tgp_minister_scholar_template
					employer = scope:new_emperor_temp
					faith = scope:new_emperor_temp.faith
					culture = scope:new_emperor_temp.culture
					save_scope_as = mandate_new_scholar_temp
				}
				scope:mandate_new_scholar_temp ?= {
					change_merit = empire_starting_merit_value
					assign_completed_exams_based_on_merit_effect = yes
				}
				create_character = {
					template = tgp_minister_scholar_template
					employer = scope:new_emperor_temp
					faith = scope:new_emperor_temp.faith
					culture = scope:new_emperor_temp.culture
					save_scope_as = mandate_new_scholar_temp
				}
				scope:mandate_new_scholar_temp ?= {
					change_merit = empire_starting_merit_value
					assign_completed_exams_based_on_merit_effect = yes
				}
				create_character = {
					template = tgp_minister_commander_template
					employer = scope:new_emperor_temp
					faith = scope:new_emperor_temp.faith
					culture = scope:new_emperor_temp.culture
					save_scope_as = mandate_new_commander_temp
				}
				scope:mandate_new_commander_temp ?= {
					change_merit = empire_starting_merit_value
					assign_completed_exams_based_on_merit_effect = yes
				}
			}
			every_courtier = {
				limit = {
					merit >= 3000
				}
				random = {
					chance = 50
					create_noble_family_effect = { GOVERNMENT_GIVER = scope:new_emperor_temp }
				}
			}
		}
	}
	# Convert eligible vassals to celestial
	custom_tooltip = {
		text = claim_mandate_turn_vassal_celestial_desc
		every_vassal_or_below = {
			limit = {
				highest_held_title_tier >= tier_county
				capital_province.county ?= {
					target_is_de_jure_liege_or_above = title:h_china
				}
				NOR = {
					# Don't change republics or theocracies
					government_has_flag = government_is_republic
					government_has_flag = government_is_theocracy
					government_has_flag = government_is_rd_han_type
					# And just in case, don't change any unfit governments
					government_has_flag = cannot_be_vassal_or_liege
				}
				capital_province ?= {
					OR = {
						has_holding_type = castle_holding
						has_holding_type = city_holding
						has_holding_type = temple_citadel_holding
					}
				}
			}
			if = {
				limit = {
					# No need to change if they are celestial already
					NOT = { government_has_flag = government_is_celestial }
				}
				change_to_administrative_effect = yes
			}
			# Give characters some merit and exams based on their position
			change_merit = {
				value = assign_merit_based_on_tier_value
				add = {
					value = age
					multiply = 2
				}
				add = {
					value = sum_of_all_skills_value
					multiply = 2
				}
			}
			assign_completed_exams_based_on_merit_effect = yes
		}
	}
	custom_tooltip = claim_mandate_turn_independent_realms_celestial_desc
	hidden_effect = {
		create_title_and_vassal_change = {
			type = swear_fealty
			save_scope_as = mandate_vassalize_celestial_families_change
		}
		# Vassalize any stray celestial noble families or independent realms within the Cycle's region - we also give them merit to fill out the candidate pools
		every_independent_ruler = {
			limit = {
				capital_province.county ?= {
					target_is_de_jure_liege_or_above = title:h_china
				}
				NOT = {	government_has_flag = cannot_be_vassal_or_liege }
				OR = {
					government_has_flag = government_is_celestial
					culture = {
						has_same_culture_heritage = scope:new_emperor_temp.culture
					}
					dynasty = scope:new_emperor_temp.dynasty
				}
			}
			change_liege = {
				liege = scope:new_emperor_temp
				change = scope:mandate_vassalize_celestial_families_change
			}
			change_merit = {
				value = { 3000 8000 }
				add = {
					value = age
					multiply = 2
				}
				add = {
					value = sum_of_all_skills_value
					multiply = 2
				}
			}
			assign_completed_exams_based_on_merit_effect = yes
			if = {
				limit = {
					highest_held_title_tier >= tier_county
					NOR = {
						# Don't change republics or theocracies
						government_has_flag = government_is_republic
						government_has_flag = government_is_theocracy
						# No need to change if they are celestial already
						government_has_flag = government_is_celestial
					}
					capital_province ?= {
						OR = {
							has_holding_type = castle_holding
							has_holding_type = city_holding
							has_holding_type = temple_citadel_holding
						}
					}
				}
				change_to_administrative_effect = yes
			}
		}
		resolve_title_and_vassal_change = scope:mandate_vassalize_celestial_families_change
		# Ensure that we get a family title and a domicile if we don't
		change_to_administrative_effect = yes
		# set up the council holder as dejure liege of the ministry title, as this effect is not called with the same scope as council onactions
		scope:new_emperor_temp = {
			save_scope_as = councillor_liege
		}
		# Make sure ministers are assigned correctly
		fill_the_ministry_effect = yes
	}
	situation:dynastic_cycle = {
		if = {
			limit = {
				situation_top_has_catalyst = catalyst_hegemon_gains_mandate_of_heaven
				scope:new_emperor_temp = {
					is_valid_celestial_dynasty = yes
				}
			}
			trigger_situation_catalyst = catalyst_hegemon_gains_mandate_of_heaven
		}
		hidden_effect = {
			every_situation_participant = {
				every_owned_story = {
					limit = {
						story_type = story_take_mandate_of_heaven
					}
					end_story = yes
				}
			}
		}
	}
}


tgp_chaos_shattering_effect = {
	hidden_effect = {
		title:h_china = {
			holder = { save_temporary_scope_as = old_emperor_temp }
			# Reset imperial examination activity
			set_variable = {
				name = years_since_imperial_examination
				value = 0
			}
		}
		#put every vassal of the current hegemon in a list
		situation:dynastic_cycle = {
			every_situation_participant = {
				limit = {
	   				top_liege = scope:old_emperor_temp
				}
				add_to_list = former_vassals
			}
		}
		scope:old_emperor_temp = {
			#destroy the title of china and all Empires that the Hegemon holds
			if = {
				limit = {
					title:h_china = {
						any_in_de_jure_hierarchy = {
						OR = {
							this = title:e_china
							this = title:e_rdwestchina_emp
							this = title:e_rdsouthchina
							this = title:e_rdnorthchina
							this = title:e_rdeastchina
						}
						is_title_created = yes
						NOT = { holder = scope:old_emperor_temp}
						}
						
					}
				
				}
				create_title_and_vassal_change = {
					type = created
					save_scope_as = change
					add_claim_on_loss = no
				}
				title:h_china = {
					random_in_de_jure_hierarchy = {
						limit = {
							OR = {
								this = title:e_china
								this = title:e_rdwestchina_emp
								this = title:e_rdsouthchina
								this = title:e_rdnorthchina
								this = title:e_rdeastchina
							}
							is_title_created = yes
							NOT = { holder = scope:old_emperor_temp}
						}
						holder = {
						 save_temporary_scope_as = rd_new_emperor_temp
						 }
					}
							change_title_holder = {
							holder = scope:rd_new_emperor_temp
							change = scope:change
						}
						resolve_title_and_vassal_change = scope:change
						scope:rd_new_emperor_temp = {
								tgp_claim_mandate_of_heaven_effect = yes
								
		custom_tooltip = claim_mandate_decision_phase_tt	
		scope:situation = {
			if = {
				limit = {
					situation_top_has_catalyst = catalyst_hegemon_gains_mandate_of_heaven
					root = {
						is_valid_celestial_dynasty = yes
					}
				}
				trigger_situation_catalyst = catalyst_hegemon_gains_mandate_of_heaven
			}
			hidden_effect = {
				every_situation_participant = {
					every_owned_story = {
						limit = {
							story_type = story_take_mandate_of_heaven
						}
						end_story = yes
					}
				}
			}
		}
				}
				}
			}
			else = {
					if = {
					
						limit = {
							has_government = rd_celestial_empire_government
						}
					every_held_title = {
						limit = {
							tier > tier_kingdom
						}
						scope:old_emperor_temp = {
							destroy_title = prev
						}
					}
					
					create_title_and_vassal_change = {
						type = independency
						save_scope_as = chaos_change
						add_claim_on_loss = yes
					}
					every_vassal = {
						limit = {
							#breakaway all non-dejure vassals
							primary_title = {
								NOT = { target_is_de_jure_liege_or_above = scope:old_emperor_temp.primary_title }
							}
						}
						becomes_independent = { change = scope:chaos_change }
					}
					}
					else = {
						every_held_title = {
						limit = {
							tier > tier_empire
						}
						scope:old_emperor_temp = {
							destroy_title = prev
						}
					}
					
					
					}
					resolve_title_and_vassal_change = scope:chaos_change

			}
			
		}
		# destroy all empire and king level titles if holders have not enough power
		if = {
				limit = {
						title:h_china = {
						any_in_de_jure_hierarchy = {
						OR = {
							this = title:e_china
										this = 		title:e_liangyi 
											this = 	 title:e_yongliang
										this =  title:e_zhongyuan 
										 this =  title:e_jingyang 
										this = 	title:e_lingnan
						}
						is_title_created = yes
						NOT = { holder = scope:old_emperor_temp}
						}
					}
				
				}
				create_title_and_vassal_change = {
						type = independency
						save_scope_as = chaos_change
						add_claim_on_loss = yes
					}
			scope:old_emperor_temp = {
				every_vassal = {
						limit = {
							#breakaway all non-dejure vassals
							primary_title = {
								NOT = { target_is_de_jure_liege_or_above = scope:old_emperor_temp.primary_title }
							}
						}
						becomes_independent = { change = scope:chaos_change }
					}
				}
		}
		else = {
			if = {
					
				limit = {
					has_government = rd_celestial_empire_government
				}
				every_in_list = {
					list = former_vassals
					if = {
						limit = {
							is_landed = yes
							is_ai = yes
							is_governor = yes
							is_vassal_of = scope:old_emperor_temp
							OR = {
								AND = {
									highest_held_title_tier = tier_empire
									
									primary_title = { 
									OR = {
										this = 	title:e_china
										this = 		title:e_liangyi 
											this = 	 title:e_yongliang
										this =  title:e_zhongyuan 
										 this =  title:e_jingyang 
										this = 	title:e_lingnan
									
									}
									
									}
									var:movement_power_individual < 100
								}
								AND = {
									highest_held_title_tier = tier_kingdom
									
									primary_title = { 
																OR = {
										target_is_de_jure_liege_or_above = 		title:e_liangyi 
											target_is_de_jure_liege_or_above = 	 title:e_yongliang
										target_is_de_jure_liege_or_above =  title:e_zhongyuan 
										 target_is_de_jure_liege_or_above =  title:e_jingyang 
										target_is_de_jure_liege_or_above = 	title:e_lingnan
										target_is_de_jure_liege_or_above = 	title:e_china
									}
									}
									var:movement_power_individual < 100
								}
							}
						}
						every_held_title = {
							limit = {
								tier > tier_duchy
							}
							prev = {
								destroy_title = prev
							}
						}
					}
				}
			}
			else = {
						every_in_list = {
				list = former_vassals
				if = {
					limit = {
						is_landed = yes
						is_ai = yes
						is_governor = yes
						is_vassal_of = scope:old_emperor_temp
						OR = {
							AND = {
								highest_held_title_tier = tier_empire
								
								primary_title = { 
								OR = {
									this = 	title:e_china
									this = 		title:e_liangyi 
										this = 	 title:e_yongliang
									this =  title:e_zhongyuan 
									 this =  title:e_jingyang 
									this = 	title:e_lingnan
								
								}
								
								}
								#var:movement_power_individual < high_movement_power_value
							}
							AND = {
								highest_held_title_tier = tier_kingdom
								
								primary_title = { 
															OR = {
									target_is_de_jure_liege_or_above = 		title:e_liangyi 
										target_is_de_jure_liege_or_above = 	 title:e_yongliang
									target_is_de_jure_liege_or_above =  title:e_zhongyuan 
									 target_is_de_jure_liege_or_above =  title:e_jingyang 
									target_is_de_jure_liege_or_above = 	title:e_lingnan
									target_is_de_jure_liege_or_above = 	title:e_china
								}
								}
								#var:movement_power_individual < decent_movement_power_value
							}
						}
					}
					
										create_title_and_vassal_change = {
						type = independency
						save_scope_as = chaos_change
						add_claim_on_loss = yes
					}
					becomes_independent = { change = scope:chaos_change }
				}
			}
												create_title_and_vassal_change = {
						type = independency
						save_scope_as = chaos_change
						add_claim_on_loss = yes
					}
				every_vassal = {
						limit = {
							#breakaway all non-dejure vassals
							primary_title = {
								NOT = { target_is_de_jure_liege_or_above = scope:old_emperor_temp.primary_title }
							}
						}
						becomes_independent = { change = scope:chaos_change }
					}
			}
		}
		every_in_list = {
			list = former_vassals
			# Destroy any held minister title
			destroy_held_ministry_titles_effect = yes
		}
		every_in_list = {
			list = former_vassals
			# let the former vassals of the hegemon become regular conquerors
			ai_chance_to_become_conqueror_effect = yes
			# put movement leaders and elders into a list
			if = {
				limit = {
					OR = {
						num_of_relation_disciple > 0
						has_variable = former_movement_leader
					}
					is_independent_ruler = yes
					is_landed = yes
				}
				add_to_list = new_lieges
			}
		}
		# remake the hierarchy by vassalizing or tributarizing non-leader movement members and disciples
		every_in_list = {
			list = new_lieges
			save_scope_as = new_liege
			every_in_list = {
				list = former_vassals
				limit = {
					OR = {
						scope:new_liege.var:former_movement_leader ?= var:former_movement_member
						has_relation_elder = scope:new_liege
					}
					this != scope:new_liege
				}
				save_scope_as = member
				# if lower tier than the potential new liege and is neighboring them or anyone that is also neighboring new liege, vassalize them
				if = {
					limit = {
						highest_held_title_tier < scope:new_liege.highest_held_title_tier
						OR = {
							primary_title = { is_neighbor_to_realm = scope:new_liege }
							any_in_list = {
								list = former_vassals
								this != scope:new_liege
								this != scope:member
								primary_title = {
									is_neighbor_to_realm = scope:new_liege
									is_neighbor_to_realm = scope:member
								}
								is_tributary_of = scope:new_liege
							}
						}
					}
					create_title_and_vassal_change = {
						type = swear_fealty
						save_scope_as = elder_hierarchy_change
						add_claim_on_loss = no
					}
					change_liege = {
						liege = scope:new_liege
						change = scope:elder_hierarchy_change
					}
					resolve_title_and_vassal_change = scope:elder_hierarchy_change
				}
				# otherwise turn into tributary
				else_if = {
					limit = {
						top_liege = scope:member
					}
					start_tributary_interaction_effect = {
						TRIBUTARY = scope:member
						SUZERAIN = scope:new_liege
					}
				}
			}
		}
		# Assign unlanded family heads to a suitable realm
		every_in_list = {
			list = former_vassals
			if = {
				limit = {
					any_held_title = { is_noble_family_title = yes }
					is_landed = no
					this = top_liege
				}
				create_title_and_vassal_change = {
					type = swear_fealty
					save_scope_as = unlanded_liege_change
					add_claim_on_loss = no
				}
				# Save the top liege of the domicile's location - If ruler's tier is above county
				if = {
					limit = {
						domicile.domicile_location.county.holder.top_liege = {
							highest_held_title_tier > tier_county
						}
					}
					domicile.domicile_location.county.holder.top_liege = {
						save_temporary_scope_as = unlanded_new_liege
					}
				}
				# Otherwise - Try and find a neighboring ruler
				else_if = {
					limit = {
						domicile.domicile_location.county.holder = {
							any_neighboring_top_liege_realm_owner = {
								highest_held_title_tier > tier_county
							}
						}
					}
					domicile.domicile_location.county.holder = {
						random_neighboring_top_liege_realm_owner = {
							limit = {
								highest_held_title_tier > tier_county
							}
							save_temporary_scope_as = unlanded_new_liege
						}
					}
				}
				change_liege = {
					liege = scope:unlanded_new_liege
					change = scope:unlanded_liege_change
				}
				resolve_title_and_vassal_change = scope:unlanded_liege_change
			}
		}
		# create a story that will make characters pursue taking the mandate
		situation:dynastic_cycle = {
			every_situation_participant = {
				if = {
					limit = {
						NOR = {
							has_trait = conqueror
							any_owned_story = {
						 		story_type = story_conqueror
							}
							any_owned_story = {
							 	story_type = story_greatest_of_khans
							}
							any_owned_story = {
								story_type = story_mongol_invasion
							}
						}
						is_landed = yes
						highest_held_title_tier >= tier_duchy
						is_tributary = no
						is_adult = yes
						is_incapable = no
						# run the ai personality triggers only for non elders and non movement leaders
						trigger_if = {
							limit = {
								NOT = {
									is_in_list = new_lieges
								}
							}
							ai_has_cautious_personality = no
							ai_boldness >= 0
							ai_greed >= 0
						}
					}
					create_story = story_take_mandate_of_heaven
				}
			}
		}
	}
	#depose the previous hegemon from all landed titles
					if = {
					
						limit = {
						scope:old_emperor_temp = {
							has_government = rd_celestial_empire_government
							}
						}
												scope:old_emperor_temp = {
		force_step_down_landed_titles = yes
	}
			}
	hidden_effect = {
		situation:dynastic_cycle = {
			every_situation_participant = {
				remove_variable = movement_member
				recalculate_participant_group = situation:dynastic_cycle
			}
		}
	}
}
