rd_convert_to_feudalism_from_administrative_liege_calls_effect = {
	#Gain some gold for selling off your estates
	if = {
		limit = {
			any_vassal = {
				any_held_title = { is_noble_family_title = yes }
				exists = domicile
			}
		}
		custom_tooltip = estates_get_bought
		every_vassal = {
			limit = { 
				any_held_title = { is_noble_family_title = yes }
				exists = domicile
			}
			hidden_effect = {
				add_gold = {
					value = {
						value = major_gold_value
						switch = {
							trigger = domicile.num_domicile_buildings
							7 = { multiply = 7 }
							6 = { multiply = 6 }
							5 = { multiply = 5 }
							4 = { multiply = 4 }
							3 = { multiply = 3 }
							2 = { multiply = 2 }
						}
					}
				}
			}	
		}
	}

	#Then change government
	if = {
		limit = { ep3_is_clan_inclined_trigger = yes }
		change_government = clan_government

		#Duchies automatically transfer, need to poke the kingdoms
		if = {
			limit = {
				any_vassal = {
					primary_title.tier >= tier_county
					government_allows = administrative
					NOR = {
						government_has_flag = government_is_clan
						government_has_flag = government_is_theocracy
					}
				}
			}
			custom_tooltip = kings_become_clan
			every_vassal = {
				limit = {
					primary_title.tier >= tier_county
					government_allows = administrative
					NOR = {
						government_has_flag = government_is_clan
						government_has_flag = government_is_theocracy
					}
				}
				hidden_effect = { change_government = clan_government }
			}
		}
	}
	else_if = {
		limit = { 
			liege = { 
				has_government = rd_han_military_government
			} 
			}
			change_government = rd_han_military_government

	#Duchies automatically transfer, need to poke the kingdoms
			if = {
				limit = {
					any_vassal = {
						primary_title.tier >= tier_county
						government_allows = administrative
						NOR = {
							government_has_flag = government_is_clan
							government_has_flag = government_is_theocracy
						}
					}
				}
				custom_tooltip = kings_become_clan
				every_vassal = {
					limit = {
						primary_title.tier >= tier_county
						government_allows = administrative
						NOR = {
							government_has_flag = government_is_clan
							government_has_flag = government_is_theocracy
						}
					}
					hidden_effect = { change_government = rd_han_military_government }
				}
			}
			
			
	}
	else = {
		change_government = feudal_government

		#Duchies automatically transfer, need to poke the kingdoms
		if = {
			limit = {
				any_vassal = {
					primary_title.tier >= tier_kingdom
					NOR = {
						government_has_flag = government_is_feudal
						government_has_flag = government_is_theocracy
					}
				}
			}
			custom_tooltip = kings_become_feudal
			every_vassal = {
				limit = {
					primary_title.tier >= tier_kingdom
					NOR = {
						government_has_flag = government_is_feudal
						government_has_flag = government_is_theocracy
					}
				}
				hidden_effect = { change_government = feudal_government }
			}
		}
	}
	
	#Governors become Dukes tooltip

}
rd_convert_to_feudalism_from_administrative_effect = {
	#Gain some gold for selling off your estates
	if = {
		limit = {
			any_vassal = {
				any_held_title = { is_noble_family_title = yes }
				exists = domicile
			}
		}
		custom_tooltip = estates_get_bought
		every_vassal = {
			limit = { 
				any_held_title = { is_noble_family_title = yes }
				exists = domicile
			}
			hidden_effect = {
				add_gold = {
					value = {
						value = major_gold_value
						switch = {
							trigger = domicile.num_domicile_buildings
							7 = { multiply = 7 }
							6 = { multiply = 6 }
							5 = { multiply = 5 }
							4 = { multiply = 4 }
							3 = { multiply = 3 }
							2 = { multiply = 2 }
						}
					}
				}
			}	
		}
	}

	#Then change government
	if = {
		limit = { ep3_is_clan_inclined_trigger = yes }
		change_government = clan_government

		#Duchies automatically transfer, need to poke the kingdoms
		if = {
			limit = {
				any_vassal = {
					primary_title.tier >= tier_kingdom
					NOR = {
						government_has_flag = government_is_clan
						government_has_flag = government_is_theocracy
					}
				}
			}
			custom_tooltip = kings_become_clan
			every_vassal = {
				limit = {
					primary_title.tier >= tier_kingdom
					NOR = {
						government_has_flag = government_is_clan
						government_has_flag = government_is_theocracy
					}
				}
				hidden_effect = { change_government = clan_government }
			}
		}
	}
	else = {
		change_government = feudal_government

		#Duchies automatically transfer, need to poke the kingdoms
		if = {
			limit = {
				any_vassal = {
					primary_title.tier >= tier_kingdom
					NOR = {
						government_has_flag = government_is_feudal
						government_has_flag = government_is_theocracy
					}
				}
			}
			custom_tooltip = kings_become_feudal
			every_vassal = {
				limit = {
					primary_title.tier >= tier_kingdom
					NOR = {
						government_has_flag = government_is_feudal
						government_has_flag = government_is_theocracy
					}
				}
				hidden_effect = { change_government = feudal_government }
			}
		}
	}
	
	#Governors become Dukes tooltip
	if = {
		limit = {
			any_vassal = {
				primary_title.tier = tier_duchy
				NOT = { government_has_flag = government_is_clan }
			}
		}
		custom_tooltip = governors_become_dukes
	}
}

rd_offer_vassalization_interaction_effect = {
	create_title_and_vassal_change = {
		type = swear_fealty
		save_scope_as = change
	}
	scope:recipient = {
		change_liege = {
			liege = scope:actor
			change = scope:change
		}
	}
	resolve_title_and_vassal_change = scope:change

	# Special terms for feudal contracts

	# Struggle catalysts.
	hidden_effect = {
			scope:recipient = {
		if = {
			limit = {
				government_has_flag = government_is_feudal
			}
			if = {
				limit = { scope:high_obligations = yes }
				hidden_effect = {
					if = {
						limit = { is_independent_ruler = no } # To avoid errors during tooltip generation (prior to the contract being generated)
						vassal_contract_set_obligation_level = { type = feudal_government_taxes level = 3 }
						vassal_contract_set_obligation_level = { type = feudal_government_levies level = 3 }
					}
				}
				custom_tooltip = high_obligations_taxes
				custom_tooltip = high_obligations_levies
			}
			else_if = {
				limit = { scope:low_obligations = yes }
				hidden_effect = {
					if = {
						limit = { is_independent_ruler = no } # To avoid errors during tooltip generation (prior to the contract being generated)
						vassal_contract_set_obligation_level = { type = feudal_government_taxes level = 1 }
						vassal_contract_set_obligation_level = { type = feudal_government_levies level = 1 }
					}
				}
				custom_tooltip = low_obligations_taxes
				custom_tooltip = low_obligations_levies
			}
			else_if = {
				limit = { scope:religious_exemption = yes }
				hidden_effect = {
					if = {
						limit = { is_independent_ruler = no } # To avoid errors during tooltip generation (prior to the contract being generated)
						vassal_contract_set_obligation_level = { type = feudal_government_taxes level = 2 }
						vassal_contract_set_obligation_level = { type = feudal_government_levies level = 1 }
						vassal_contract_set_obligation_level = { type = religious_rights level = 1 }
					}
				}
				custom_tooltip = normal_obligations_taxes
				custom_tooltip = low_obligations_levies
				custom_tooltip = religious_protection_tt
			}
			else = {
				hidden_effect = {
					if = {
						limit = { is_independent_ruler = no } # To avoid errors during tooltip generation (prior to the contract being generated)
						vassal_contract_set_obligation_level = { type = feudal_government_taxes level = 2 }
						vassal_contract_set_obligation_level = { type = feudal_government_levies level = 2 }
					}
				}
				custom_tooltip = normal_obligations_taxes
				custom_tooltip = normal_obligations_levies
			}
		}
		else_if = {
			limit = {
				government_has_flag = government_is_clan
				scope:religious_exemption_clan = yes
			}
			hidden_effect = {
				if = {
					limit = { is_independent_ruler = no } # To avoid errors during tooltip generation (prior to the contract being generated)
					vassal_contract_set_obligation_level = { type = religious_rights level = 1 }
				}
			}
			custom_tooltip = religious_protection_tt
		}
	}

		fp3_struggle_apply_independent_vassalage_catalyst_effect = {
			NEW_LIEGE = scope:actor
			NEW_VASSAL = scope:recipient
		}
	}
}

rd_change_to_administrative_effect = {
	save_scope_as = governor
	if = {
		limit = {
			NOT = { government_has_flag = government_is_administrative }
		}
		change_government = administrative_government
		save_scope_as = new_admin
	}
	if = {
		limit = {
			primary_title.tier >= tier_duchy
			liege = {
				is_independent_ruler = yes
				government_allows = administrative
			}
			house.house_head = {
				NOT = {
					any_held_title = { is_noble_family_title = yes }
				}
			}
		}
		rd_create_noble_family_effect = yes
	}

	hidden_effect = {
		if = {
			limit = {
				is_governor = yes
				NOT = { has_trait = governor }
			}
			add_trait = governor
		}
	}
	if = {
		limit = { exists = scope:new_admin }
		domicile ?= {
			set_up_domicile_estate_effect = yes
		}
	}
}

rd_convert_to_administrative_from_feudalism_effect = {
	save_scope_as = administrative_liege

	change_government = rd_han_administrative_government


	#Direct Vassals who fulfill the ep3_vassal_will_become_admin criteria are converted. Vassals above 25 opinion always accept
	#Vassals are converted as a hierarchy. If a king is converted we convert all who are valid below that king (so his dukes, their counts, and their barons) are all converted.
	#If a vassal does not convert (because of not accepting or because they are outside of the de jure empire, etc) then the vassals below them are _not_ converted either.

	#Human vassals are given a choice to convert or not in the ping event, even if powerful or having very good relation.

		trigger_event = {
			id = rd_asia.9002
			days = 3
		}

	if = {
		limit = {
			NOT = {
				has_character_flag = latin_emp_force_admin_flag
			}
			is_independent_ruler = yes
		}
		add_character_modifier = {
			modifier = first_admin_emperor
		}
	}
	
	change_influence = admin_convert_influence_value
	if = {
		limit = {
			is_independent_ruler = yes
		}
		add_legitimacy_effect = { LEGITIMACY = admin_convert_legitimacy_value } #One Time Legitimacy Boost
	}

	custom_description_no_bullet = {
		text = vassals_can_become_administrative
	}
	custom_tooltip = vassals_who_may_switch_to_administrative
}


rd_create_noble_family_effect = {
	debug_log = create_noble_family_title

	save_scope_as = new_noble_family_holder
	hidden_effect = { # NF can only be held by house heads
		if = { # Start by checking that we are not the house head already
			limit = {
				house ?= {
					house_head != scope:new_noble_family_holder
				}
			}
			if = { # If not, let's see if it would be reasonable to become house head...
				limit = {
					house ?= {
						house_head ?= {
							top_liege = scope:new_noble_family_holder.top_liege
							OR = {
								is_ruler = no
								primary_title = {
									tier <= tier_county
								}
							}
							is_ai = yes #  Don't steal house head from a player
						}
					}
				}
				house = { set_house_head = scope:new_noble_family_holder }
			}
			else = { # ... Otherwise, we create a cadet branch
				create_cadet_branch = {
				
				}
			}
		}
	}
	if = {
	limit = {
	has_government = rd_han_administrative_government
	}
	give_noble_family_title = {
		name = noble_family_name
		article = DEFAULT_TITLE_NAME_ARTICLE
		government = rd_han_administrative_government
		save_scope_as = new_title
	}
	}
	else = {
		give_noble_family_title = {
		name = noble_family_name
		article = DEFAULT_TITLE_NAME_ARTICLE
		save_scope_as = new_title
	}
	}
	
	scope:new_title = {
		holder = {
			save_scope_as = noble_family_head
		}
		set_coa = scope:noble_family_head.house
	}
	custom_description = {
		text = create_noble_family_tt
	}

	#Notifications
	top_liege ?= {
		every_vassal = {
			limit = {
				is_ai = no
				NOT = { this = scope:new_noble_family_holder }
			}
			trigger_event = {
				id = ep3_emperor_yearly.2410
				days = 1
			}
		}
	}

	debug_log_scopes = yes
}
rd_set_up_domicile_estate_effect = {
	if = {
		limit = { is_domicile_type = estate }
		# Intentionally one level lower than what you can get
		if = {
			limit = {
				NOT = { has_domicile_building_or_higher = estate_main_02 }
				owner.culture ?= { has_innovation = innovation_city_planning }
			}
			add_domicile_building = estate_main_02
		}
		if = {
			limit = {
				has_domicile_building = estate_main_02
				NOT = { has_domicile_building_or_higher = estate_main_03 }
				owner.culture ?= { has_innovation = innovation_manorialism }
			}
			add_domicile_building = estate_main_03
		}
		switch = {
			trigger = has_domicile_building
			estate_main_03 = {
				while = {
					count = 2
					add_random_internal_estate_building = yes
				}
			}
			estate_main_02 = {
				add_random_internal_estate_building = yes
			}
		}
		fill_external_estate_building_effect = yes
	}
}


rd_backup_change_to_administrative_effect = {
	save_scope_as = governor
	top_liege = { save_scope_as = governor_liege }
	if = {
		limit = {
			OR = {
				NOT = { government_allows = administrative }
				AND = {
					government_allows = administrative
					scope:governor_liege = { government_has_flag = government_is_japan_administrative }
					NOT = { government_has_flag = government_is_japan_administrative }
				}
				AND = {
					government_allows = administrative
					scope:governor_liege = { government_has_flag = government_is_meritocratic }
					NOT = { government_has_flag = government_is_meritocratic }
				}
				AND = {
					government_allows = administrative
					scope:governor_liege = { government_has_flag = government_is_celestial }
					NOT = { government_has_flag = government_is_celestial }
				}
				AND = {
					government_allows = administrative
					scope:governor_liege = { government_has_flag = government_is_steppe_admin }
					NOT = { government_has_flag = government_is_steppe_admin }
				}
			}
		}
		# Only case where Estate type is shared between Admin and non-Admin
		if = {
			limit = {
				NAND = {
					government_has_flag = government_is_japan_feudal
					scope:governor_liege = { government_has_flag = government_is_japan_administrative }
				}
			}
			save_scope_as = new_admin
		}
		# Change government
		if = {
			limit = {
				scope:governor_liege = { government_has_flag = government_is_japan_administrative }
			}
			tgp_domicile_conversion_when_changing_government_type = {
				NEW_DOMICILE_TYPE = japanese_manor
				NEW_GOVERNMENT_TYPE = japan_administrative_government
			}
			change_government = japan_administrative_government
		}
		else_if = {
			limit = {
				OR = {
					#This is Mongol breakup and they are hegemon
					AND = {
						exists = scope:great_yuan_ruler
						this = scope:great_yuan_ruler
						primary_title = title:h_china
					}
					scope:governor_liege = { government_has_flag = government_is_celestial }
				}
			}
			capital_province = {
				if = {
					limit = {
						OR = {
							has_holding_type = tribal_holding
							has_holding_type = herder_holding
							has_holding_type = nomad_holding
						}
					}
					set_holding_type = castle_holding
				}
			}
			tgp_domicile_conversion_when_changing_government_type = {
				NEW_DOMICILE_TYPE = east_asian_estate
				NEW_GOVERNMENT_TYPE = celestial_government
			}
			change_government = celestial_government
		}
		else_if = {
			limit = {
				scope:governor_liege = { government_has_flag = government_is_steppe_admin }
			}
			capital_province = {
				if = {
					limit = {
						OR = {
							has_holding_type = tribal_holding
							has_holding_type = herder_holding
							has_holding_type = nomad_holding
						}
					}
					set_holding_type = castle_holding
				}
			}
			tgp_domicile_conversion_when_changing_government_type = {
				NEW_DOMICILE_TYPE = east_asian_estate
				NEW_GOVERNMENT_TYPE = steppe_admin_government
			}
			change_government = steppe_admin_government
		}
		else_if = {
			limit = {
				OR = {
					scope:governor_liege = { government_has_flag = government_is_meritocratic }
					tgp_should_become_meritocratic_trigger = yes
				}
			}
			capital_province = {
				if = {
					limit = {
						OR = {
							has_holding_type = tribal_holding
							has_holding_type = herder_holding
							has_holding_type = nomad_holding
						}
					}
					set_holding_type = castle_holding
				}
			}
			tgp_domicile_conversion_when_changing_government_type = {
				NEW_DOMICILE_TYPE = east_asian_estate
				NEW_GOVERNMENT_TYPE = meritocratic_government
			}
			change_government = meritocratic_government
		}
		else = {
			capital_province = {
				if = {
					limit = {
						OR = {
							has_holding_type = tribal_holding
							has_holding_type = herder_holding
							has_holding_type = nomad_holding
						}
					}
					set_holding_type = castle_holding
				}
			}
			add_character_flag = new_government_is_byz_admin
			tgp_domicile_conversion_when_changing_government_type = {
				NEW_DOMICILE_TYPE = estate
				NEW_GOVERNMENT_TYPE = administrative_government
			}
			change_government = administrative_government 
			remove_character_flag = new_government_is_byz_admin
		}
	}
	if = {
		limit = {
			primary_title.tier >= min_appointment_tier
			liege = {
				scope:governor_liege = this
				government_allows = administrative
			}
			house.house_head = {
				top_liege = scope:governor_liege
				NOT = {
					any_held_title = { is_noble_family_title = yes }
				}
			}
		}
		create_noble_family_effect = { GOVERNMENT_GIVER = top_liege }
	}
	if = {
		limit = {
			primary_title.tier >= min_appointment_tier
			liege = {
				scope:governor_liege = this
				NOT = { government_has_flag = government_is_rd_han_type }
				government_allows = administrative
				government_has_flag = government_is_celestial
			}
			house.house_head = {
				top_liege = scope:governor_liege
				NOT = {
					any_held_title = { is_noble_family_title = yes }
				}
			}
		}
		create_noble_family_effect = { GOVERNMENT_GIVER = top_liege }
	}
	else_if = {
		limit = {
			primary_title.tier >= min_appointment_tier
			liege = {
				scope:governor_liege = this
				government_has_flag = government_is_rd_han_type
				government_has_flag = government_is_celestial
			}
			house.house_head = {
				top_liege = scope:governor_liege
				NOT = {
					any_held_title = { is_noble_family_title = yes }
				}
			}
		}
		give_noble_family_title = {
				name = noble_family_name
				tier = county
				article = DEFAULT_TITLE_NAME_ARTICLE
				government = celestial_government
				save_scope_as = new_title
			}
		domicile ?= {
			set_up_domicile_estate_effect = yes
		}
	}
	hidden_effect = {
		if = {
			limit = {
				is_governor = yes
				NOT = { has_trait = governor }
			}
			add_trait = governor
		}
	}
	if = {
		limit = {
			exists = scope:new_admin
			exists = domicile
		}
		domicile ?= {
			set_up_domicile_estate_effect = yes
		}
	}
}