namespace = rd_faction_demand

scripted_effect rd_faction_demand_liberty_counter_offer_corule_accepted_effect = {
	add_dread = medium_dread_loss
	# LEGITIMACY LOSS FOR ACCEPTING FACTION DEMANDS
	faction_accept_demand_legitimacy_effect = yes
	add_prestige = -200
	add_character_flag = {
		flag = recent_liberty_faction_war
		years = 10
	}
	custom_tooltip = {
		text = rd_faction_demand.0000.truce_from_co_rule
		scope:faction = {
			every_faction_member = {
				save_scope_as = recipient # Ensuring it localizes correctly
				add_truce_both_ways = {
					character = scope:faction.faction_target
					years = faction_counter_offer_appointed_co_emperor_value
					name = ep3_truce_appointed_faction_leader_coruler
				}
			}
		}
	}
	scope:faction = { destroy_faction = yes }
	# This effect should always be placed here, _after_ everything except the ai_chance.
	trigger_event = { on_action = on_faction_demand_accepted }
}

scripted_effect rd_faction_demand_liberty_rejected_effect = {
	# This effect should always be placed here, _before_ all the other effects in the block.
	trigger_event = { on_action = on_faction_demand_rejected }

	show_as_tooltip = {
		scope:faction = {
			faction_start_war = {}
			custom_tooltip = faction_starts_war.tt.replacement
		}
	}
}

scripted_trigger faction_leader_would_consider_turning_down_co_emperorship_trigger = {
	OR = {
		is_ai = no
		# Won't change their mind.
		AND = {
			has_trait = stubborn
			NOR = {
				has_trait = arrogant
				has_trait = ambitious
			}
		}
		# Eyes on the prize.
		AND = {
			has_trait = humble
			NOT = { has_trait = ambitious }
		}
		# Not swayed by high office.
		AND = {
			has_trait = content
			NOT = { has_trait = arrogant }
		}
	}
}

scripted_effect faction_demand_liberty_counter_offer_corule_accepted_effect = {
	add_dread = medium_dread_loss
	# LEGITIMACY LOSS FOR ACCEPTING FACTION DEMANDS
	faction_accept_demand_legitimacy_effect = yes
	add_prestige = -200
	add_character_flag = {
		flag = recent_liberty_faction_war
		years = 10
	}
	custom_tooltip = {
		text = faction_demand.0000.truce_from_co_rule
		scope:faction = {
			every_faction_member = {
				save_scope_as = recipient # Ensuring it localizes correctly
				add_truce_both_ways = {
					character = scope:faction.faction_target
					years = faction_counter_offer_appointed_co_emperor_value
					name = ep3_truce_appointed_faction_leader_coruler
				}
			}
		}
	}
	scope:faction = { destroy_faction = yes }
	# This effect should always be placed here, _after_ everything except the ai_chance.
	trigger_event = { on_action = on_faction_demand_accepted }
}

scripted_effect faction_demand_liberty_rejected_effect = {
	# This effect should always be placed here, _before_ all the other effects in the block.
	trigger_event = { on_action = on_faction_demand_rejected }

	show_as_tooltip = {
		scope:faction = {
			faction_start_war = {}
			custom_tooltip = faction_starts_war.tt.replacement
		}
	}
}

scripted_trigger faction_target_can_attempt_to_bribe_with_co_emperorship_trigger = {
	may_appoint_co_emperors_trigger = yes
	has_active_diarchy = no
}

scripted_effect faction_demand_counter_offer_co_rule_start_diarchy_effect = {
	custom_tooltip = {
		text = faction_demand.0000.enter_co_rule_avoiding_worst_effects
		start_diarchy = co_emperorship
		set_diarch = scope:faction_leader
		change_diarchy_swing = 30
		reverse_add_opinion = {
			target = scope:faction_leader
			modifier = respect_opinion
			opinion = 50
		}
	}
}



# Liberty Faction Demand
# by Henrik Fåhraeus
rd_faction_demand.0101 = {
	type = letter_event
	sender = scope:faction_leader
	opening = {
		desc = "FACTION_DEMAND_LIBERTY"
	}
	desc = "FACTION_DEMAND_LIBERTY_DESC"
	
	trigger = {
		# May have ceased to exist by the time this triggers
		exists = scope:faction
	}

	immediate = {
		# Grab our scope for loc.
		save_scope_as = faction_target
	}

	option = {
		name = "FACTION_DEMAND_ACCEPT"

		# This effect should always be placed here, _before_ all the other effects in the block.
		trigger_event = { on_action = on_faction_demand_accepted }

		add_dread = medium_dread_loss

		# LEGITIMACY LOSS FOR ACCEPTING FACTION DEMANDS
		faction_accept_demand_legitimacy_effect = yes
		
		switch = {
			trigger = has_realm_law
			imperial_bureaucracy_1 = { add_realm_law = imperial_bureaucracy_0 }
			imperial_bureaucracy_2 = { add_realm_law = imperial_bureaucracy_1 }
			imperial_bureaucracy_3 = { add_realm_law = imperial_bureaucracy_2 }
			tribal_authority_1 = { add_realm_law = tribal_authority_0 }
			tribal_authority_2 = { add_realm_law = tribal_authority_1 }
			tribal_authority_3 = { add_realm_law = tribal_authority_2 }
			crown_authority_1 = { add_realm_law = crown_authority_0 }
			crown_authority_2 = { add_realm_law = crown_authority_1 }
			crown_authority_3 = { add_realm_law = crown_authority_2 }
		}

		add_realm_law = acclamation_succession_law 	
			add_prestige = -1000

		add_character_flag = {
			flag = recent_liberty_faction_war
			years = 10
		}

		scope:faction_leader = {
			trigger_event = {
				id = rd_faction_demand.0102
			}
		}

		scope:faction = {
			destroy_faction = yes
		}

		# This effect should always be placed here, _after_ everything except the ai_chance.
		trigger_event = { on_action = on_faction_demand_accepted }

		ai_chance = {
			base = 10
			modifier = {
				add = 90
				scope:faction = { faction_power >= 100 }
			}
			modifier = {
				add = 50
				scope:faction = { faction_power >= 125 }
			}
			modifier = {
				add = 50
				scope:faction = { faction_power >= 150 }
			}
			modifier = {
				add = 50
				scope:faction = { faction_power >= 200 }
			}
			modifier = {
				add = 50
				any_character_war = {
					is_war_leader = root
					is_defender = root
				}
			}
			modifier = {
				factor = 0.1
				any_ally = {
					NOR = {
						target_is_liege_or_above = root
						target_is_vassal_or_below = root
					}
					max_military_strength > root.max_military_strength
				}
			}
		}
	}

	option = {
		name = "FACTION_DEMAND_BRIBE_CO_EMPEROR"
		show_as_unavailable = { has_active_diarchy = yes }
		trigger = { faction_target_can_attempt_to_bribe_with_co_emperorship_trigger = yes }

		# Ping-pong the choice back to the target.
		## Laying out the consequences.
		show_as_tooltip = {
			random_list = {
				# They accept!
				100 = {
					desc = rd_faction_demand.0000.faction_leader_accepts
					show_chance = no
					faction_demand_counter_offer_co_rule_start_diarchy_effect = yes
					faction_demand_liberty_counter_offer_corule_accepted_effect = yes
				}
				# They decline.
				100 = {
					desc = rd_faction_demand.0000.faction_leader_rejects
					show_chance = no
					faction_demand_liberty_rejected_effect = yes
				}
			}
		}
		## And sorting the actual flow.
		scope:faction_leader = { trigger_event = rd_faction_demand.0106 }

		ai_chance = { liege_offer_co_emperorship_to_faction_leader_modifier = yes }
	}

	option = {
		name = "FACTION_DEMAND_REFUSE"

		faction_demand_liberty_rejected_effect = yes

		scope:faction_leader = {
			trigger_event = {
				id = rd_faction_demand.0103
				days = 1
			}
		}

		ai_chance = {
			base = 100
			ai_value_modifier = {
				ai_boldness = 4.0
			}
			modifier = {
				add = 50
				scope:faction = { faction_power < 80 }
			}
			modifier = {
				add = 100
				scope:faction = { faction_power < 60 }
			}
			modifier = {
				add = 1000
				scope:faction = { faction_power < 40 }
			}
		}
	}
}

# Liberty Faction Demand Accepted
# by Henrik Fåhraeus
rd_faction_demand.0102 = {
	type = letter_event
	sender = scope:faction_target
	opening = {
		desc = "FACTION_DEMAND_LIBERTY_ACCEPTED"
	}
	desc = "FACTION_DEMAND_LIBERTY_ACCEPTED_DESC"

	option = {
		name = "FACTION_DEMAND_ACCEPTED_OPT"
		custom_tooltip = rd_faction_demand.0102.tt
	}
}

# Liberty Faction Demand Refused
# by Henrik Fåhraeus
rd_faction_demand.0103 = {
	type = letter_event
	sender = scope:faction_target
	opening = {
		desc = "FACTION_DEMAND_LIBERTY_REFUSED"
	}
	desc = "FACTION_DEMAND_LIBERTY_REFUSED_DESC"

	option = {
		name = "FACTION_DEMAND_REFUSED_OPT"
		scope:faction = {
			faction_start_war = {}
			
			every_faction_member = {
				limit = { NOT = { this = scope:faction.faction_leader } }
				trigger_event = rd_faction_demand.0104
			}
		}
	}
}

# Liberty Faction Demand Refused Member Notice
# by Henrik Fåhraeus
rd_faction_demand.0104 = {
	type = letter_event
	sender = scope:faction_target
	opening = {
		desc = "FACTION_DEMAND_LIBERTY_REFUSED"
	}
	desc = "FACTION_DEMAND_LIBERTY_REFUSED_DESC"

	option = {
		name = "FACTION_DEMAND_REFUSED_OPT"	
	}
}

# Liberty Faction Demand Send Notice
# by Henrik Fåhraeus
rd_faction_demand.0105 = {
	type = letter_event
	sender = scope:faction_leader
	opening = {
		desc = "FACTION_DEMAND_LIBERTY_SEND_DEMAND_NOTIFICATION"
	}
	desc = "FACTION_DEMAND_LIBERTY_SEND_DEMAND_NOTIFICATION_DESC"

	option = {
		name = "FACTION_DEMAND_SEND_DEMAND_NOTIFICATION_OPT"	
	}
}

# Co-emperor counter-offer.
rd_faction_demand.0106 = {
	type = letter_event
	sender = scope:faction_target
	opening = FACTION_DEMAND_COUNTER_OFFER_CORULE
	desc = FACTION_DEMAND_COUNTER_OFFER_CORULE_DESC
	
	option = {
		name = FACTION_DEMAND_COUNTER_OFFER_CORULE_ACCEPT

		# Inform the relevant parties.
		hidden_effect = {
			scope:faction_target = {
				send_interface_toast = {
					type = msg_start_diarchy
					title = rd_faction_demand.0000.offer_accepted
					show_as_tooltip = { custom_tooltip = rd_faction_demand.0000.enter_co_emperorship }
				}
			}
			scope:faction = {
				every_faction_member = {
					limit = {
						is_ai = no
						NOT = { this = scope:faction_leader }
					}
					trigger_event = rd_faction_demand.9011
				}
			}
		}
		# Actual effects.
		scope:faction_target = {
			faction_demand_counter_offer_co_rule_start_diarchy_effect = yes
			faction_demand_liberty_counter_offer_corule_accepted_effect = yes
		}

		# Low weight: we control the AI accepting this by toggling whether they can access the refusal option at all.
		ai_chance = { base = 20 }
	}

	option = {
		name = FACTION_DEMAND_COUNTER_OFFER_CORULE_REJECT
		trigger = { faction_leader_would_consider_turning_down_co_emperorship_trigger = yes }

		# Inform the relevant parties.
		hidden_effect = {
			scope:faction_target = {
				send_interface_toast = {
					type = msg_war_declared_on_me
					title = rd_faction_demand.0000.offer_rejected
					show_as_tooltip = {
						scope:faction = { custom_tooltip = faction_starts_war.tt.replacement }
					}
				}
			}
		}
		# Actual effects.
		faction_demand_liberty_rejected_effect = yes

		# If the AI can access this at all then they should strongly consider it.
		ai_chance = { base = 80 }
	}
}